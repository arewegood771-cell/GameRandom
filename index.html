<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Piano Sheet Player</title>

<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
body {
  margin: 0;
  background: linear-gradient(to bottom, #001a4d, #0d47a1, #1976d2);
}
.key-white {
  width: 40px;
  height: 160px;
  background: white;
  border: 1px solid #ccc;
  position: relative;
}
.key-white.active {
  background: #60a5fa;
}
.key-black {
  width: 26px;
  height: 100px;
  background: black;
  position: absolute;
  top: 0;
  right: -13px;
  z-index: 10;
}
.key-black.active {
  background: #2563eb;
}
</style>
</head>

<body>
<div id="root"></div>

<script type="text/babel" data-presets="react">

const NOTES = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];

const noteToFreq = (note) => {
  const m = note.match(/^([A-G]#?)(\d)$/);
  if (!m) return null;
  const idx = NOTES.indexOf(m[1]) + parseInt(m[2]) * 12;
  const a4 = NOTES.indexOf("A") + 4 * 12;
  return 440 * Math.pow(2, (idx - a4) / 12);
};

const generateKeys = () => {
  const keys = [];
  for (let o = 3; o <= 5; o++) {
    for (let n of NOTES) {
      keys.push({
        note: n + o,
        sharp: n.includes("#"),
        freq: noteToFreq(n + o)
      });
    }
  }
  return keys;
};

const Piano = () => {
  const [sheet, setSheet] = React.useState("");
  const [active, setActive] = React.useState("");
  const [isPlaying, setIsPlaying] = React.useState(false);

  const audioCtx = React.useRef(null);
  const timers = React.useRef([]);
  const keys = generateKeys();

  const getAudio = async () => {
    if (!audioCtx.current) {
      audioCtx.current = new (window.AudioContext || window.webkitAudioContext)();
    }
    if (audioCtx.current.state === "suspended") {
      await audioCtx.current.resume();
    }
    return audioCtx.current;
  };

  const playNote = async (freq, duration = 300) => {
    const ctx = await getAudio();
    const osc1 = ctx.createOscillator();
    const osc2 = ctx.createOscillator();
    const gain = ctx.createGain();

    osc1.type = "sine";
    osc2.type = "triangle";
    osc1.frequency.value = freq;
    osc2.frequency.value = freq * 2;

    osc1.connect(gain);
    osc2.connect(gain);
    gain.connect(ctx.destination);

    const t = ctx.currentTime;
    const d = duration / 1000;

    gain.gain.setValueAtTime(0, t);
    gain.gain.linearRampToValueAtTime(0.7, t + 0.01);
    gain.gain.exponentialRampToValueAtTime(0.001, t + d);

    osc1.start(t);
    osc2.start(t);
    osc1.stop(t + d);
    osc2.stop(t + d);
  };

  const parseSheet = (text) =>
    text.trim().split(/\s+/).map(s => {
      const [n, d] = s.split("-");
      return { note: n.toUpperCase(), duration: parseInt(d) || 300 };
    });

  const stop = () => {
    timers.current.forEach(clearTimeout);
    timers.current = [];
    setIsPlaying(false);
    setActive("");
  };

  const play = async () => {
    await getAudio();
    stop();
    setIsPlaying(true);

    const data = parseSheet(sheet);
    let time = 0;

    data.forEach((n, i) => {
      const freq = noteToFreq(n.note);
      if (!freq) return;

      const t = setTimeout(() => {
        playNote(freq, n.duration);
        setActive(n.note);
        setTimeout(() => setActive(""), n.duration);
        if (i === data.length - 1) {
          setTimeout(() => setIsPlaying(false), n.duration);
        }
      }, time);

      timers.current.push(t);
      time += n.duration;
    });
  };

  return (
    <div className="min-h-screen flex flex-col items-center p-4">
      <h1 className="text-white text-3xl font-bold mb-3">üéπ Piano Sheet Player</h1>

      <textarea
        className="w-full max-w-3xl h-32 p-3 rounded bg-black/40 text-white font-mono mb-3"
        placeholder="C4-300 E4-300 G4-300 C5-600"
        value={sheet}
        onChange={e => setSheet(e.target.value)}
      />

      <div className="flex gap-2 mb-4">
        <button onClick={play} className="bg-green-500 text-white px-6 py-2 rounded">
          ‚ñ∂ Play
        </button>
        <button onClick={stop} className="bg-red-500 text-white px-6 py-2 rounded">
          ‚èπ Stop
        </button>
      </div>

      {/* üéπ PIANO */}
      <div className="relative flex">
        {keys.map((k, i) =>
          !k.sharp && (
            <div
              key={k.note}
              className={`key-white ${active === k.note ? "active" : ""}`}
              onClick={() => {
                playNote(k.freq);
                setActive(k.note);
                setTimeout(() => setActive(""), 200);
              }}
            >
              {keys[i + 1] && keys[i + 1].sharp && (
                <div
                  className={`key-black ${active === keys[i + 1].note ? "active" : ""}`}
                  onClick={(e) => {
                    e.stopPropagation();
                    playNote(keys[i + 1].freq);
                    setActive(keys[i + 1].note);
                    setTimeout(() => setActive(""), 200);
                  }}
                />
              )}
            </div>
          )
        )}
      </div>

      <div className="text-white/70 mt-2">Active: {active || "-"}</div>
    </div>
  );
};

ReactDOM.createRoot(document.getElementById("root")).render(<Piano />);

</script>
</body>
</html>

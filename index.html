<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TEMBAK! â€” Multiplayer Shooter</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Share+Tech+Mono&family=Russo+One&display=swap" rel="stylesheet">
<style>
:root {
  --bg:     #0e0e0e;
  --panel:  #1a1a1a;
  --border: #2e2e2e;
  --bd2:    #3a3a3a;
  --text:   #c8c8c8;
  --muted:  #555;
  --bright: #f0f0f0;
  --silver: #999;
  --bb3:    #505050;
  --gold:   #e0b840;
  --blood:  #ff2233;
}
*{box-sizing:border-box;margin:0;padding:0;}
html,body{width:100%;height:100%;background:var(--bg);overflow:hidden;font-family:'Share Tech Mono',monospace;color:var(--text);cursor:crosshair;}

body::before{content:'';position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 39px,rgba(255,255,255,.015) 40px),repeating-linear-gradient(90deg,transparent,transparent 39px,rgba(255,255,255,.015) 40px);pointer-events:none;z-index:0;}

/* â”€â”€â”€ TITLE â”€â”€â”€ */
#screen-title{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(155deg,#111 0%,#0a0a0a 50%,#141414 100%);z-index:100;overflow-y:auto;padding:20px 0;}
.stripe{position:fixed;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,#444,#aaa,#444,transparent);}

.game-logo{font-family:'Bebas Neue',cursive;font-size:clamp(3rem,11vw,6.5rem);letter-spacing:.12em;position:relative;z-index:1;line-height:1;margin-bottom:.08em;}
.game-logo span{background:linear-gradient(180deg,#fff 0%,#999 45%,#444 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;filter:drop-shadow(2px 3px 0 #000);}
.logo-sub{font-family:'Share Tech Mono',monospace;font-size:clamp(.5rem,1.4vw,.72rem);letter-spacing:.5em;color:var(--muted);margin-bottom:2rem;position:relative;z-index:1;}

.panel{background:var(--panel);border:1px solid var(--border);border-radius:1px;padding:1.6rem 1.8rem;width:min(460px,95vw);position:relative;z-index:1;box-shadow:0 8px 40px rgba(0,0,0,.65),inset 0 1px 0 rgba(255,255,255,.04);}
.panel::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--bb3),var(--silver),var(--bb3),transparent);}
.corner{position:absolute;width:9px;height:9px;}
.corner-tl{top:-1px;left:-1px;border-top:2px solid var(--silver);border-left:2px solid var(--silver);}
.corner-tr{top:-1px;right:-1px;border-top:2px solid var(--silver);border-right:2px solid var(--silver);}
.corner-bl{bottom:-1px;left:-1px;border-bottom:2px solid var(--silver);border-left:2px solid var(--silver);}
.corner-br{bottom:-1px;right:-1px;border-bottom:2px solid var(--silver);border-right:2px solid var(--silver);}

.lbl{display:block;font-size:.57rem;letter-spacing:.25em;color:var(--muted);margin-bottom:.32rem;text-transform:uppercase;}
.inp{width:100%;background:#0f0f0f;border:1px solid var(--bd2);color:var(--bright);font-family:'Share Tech Mono',monospace;font-size:.92rem;padding:.62rem .85rem;border-radius:1px;outline:none;transition:border-color .18s;margin-bottom:1rem;}
.inp:focus{border-color:var(--silver);}
.inp::placeholder{color:#2a2a2a;}

/* â”€â”€â”€ AVATAR TABS â”€â”€â”€ */
.avatar-tabs{display:flex;gap:.4rem;margin-bottom:.7rem;}
.av-tab{flex:1;padding:.4rem;text-align:center;font-family:'Bebas Neue',cursive;font-size:.85rem;letter-spacing:.15em;color:var(--muted);border:1px solid var(--border);border-radius:1px;cursor:pointer;transition:all .15s;}
.av-tab:hover{color:var(--text);border-color:var(--bd2);}
.av-tab.active{color:var(--bright);border-color:var(--silver);background:rgba(255,255,255,.04);}

.av-pane{display:none;}
.av-pane.active{display:block;}

/* DRAW pane */
.draw-wrap{display:flex;gap:.9rem;align-items:flex-start;}
.canvas-col{flex-shrink:0;display:flex;flex-direction:column;align-items:center;gap:5px;}
#draw-canvas{border:1px solid var(--bd2);border-radius:1px;background:#0a0a0a;cursor:crosshair;touch-action:none;}
.ch{font-size:.5rem;color:var(--muted);letter-spacing:.08em;}
.tools-col{flex:1;display:flex;flex-direction:column;gap:.55rem;}
.tl{font-size:.52rem;color:var(--muted);letter-spacing:.15em;margin-bottom:.2rem;}
.swatch-row{display:flex;flex-wrap:wrap;gap:.32rem;}
.sw{width:20px;height:20px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:all .1s;position:relative;}
.sw:hover{transform:scale(1.15);}
.sw.on{border-color:#fff;transform:scale(1.2);}
.sw.on::after{content:'âœ“';position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:.5rem;color:rgba(0,0,0,.7);}
.sz-row{display:flex;gap:.3rem;}
.szb{width:26px;height:26px;border-radius:1px;background:#111;border:1px solid var(--border);color:var(--muted);font-size:.65rem;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .12s;}
.szb:hover{border-color:var(--silver);color:var(--bright);}
.szb.on{border-color:var(--silver);background:rgba(255,255,255,.07);color:#fff;}
.tb-row{display:flex;gap:.3rem;}
.tb{padding:.25rem .5rem;border-radius:1px;background:#111;border:1px solid var(--border);color:var(--muted);font-size:.58rem;cursor:pointer;transition:all .12s;letter-spacing:.06em;}
.tb:hover{border-color:var(--silver);color:var(--bright);}
.tb.on{border-color:var(--silver);background:rgba(255,255,255,.06);color:#fff;}
.act-row{display:flex;gap:.3rem;margin-top:.15rem;}
.ab{flex:1;padding:.28rem;text-align:center;background:#111;border:1px solid var(--border);color:var(--muted);font-size:.58rem;cursor:pointer;border-radius:1px;transition:all .12s;letter-spacing:.06em;}
.ab:hover{border-color:var(--bd2);color:var(--text);}

/* UPLOAD pane */
.upload-wrap{display:flex;flex-direction:column;align-items:center;gap:.7rem;}
.upload-drop{
  width:100%;padding:1.5rem;border:1px dashed var(--bd2);border-radius:1px;
  background:#0f0f0f;text-align:center;cursor:pointer;transition:all .18s;
  display:flex;flex-direction:column;align-items:center;gap:.4rem;
}
.upload-drop:hover,.upload-drop.drag{border-color:var(--silver);background:rgba(255,255,255,.03);}
.upload-icon{font-size:2rem;filter:grayscale(1);}
.upload-txt{font-size:.65rem;color:var(--muted);letter-spacing:.1em;}
.upload-hint{font-size:.55rem;color:#333;letter-spacing:.08em;}
#file-input{display:none;}
.preview-row{display:flex;gap:.8rem;align-items:center;}
#upload-preview{width:80px;height:80px;object-fit:cover;border:1px solid var(--bd2);border-radius:1px;background:#0a0a0a;display:none;}
.upload-info{flex:1;}
#upload-filename{font-size:.7rem;color:var(--text);word-break:break-all;}
#upload-clear{font-size:.6rem;color:var(--muted);cursor:pointer;text-decoration:underline;margin-top:.3rem;display:none;}
#upload-clear:hover{color:var(--text);}

/* â”€â”€â”€ BUTTONS â”€â”€â”€ */
.btn{width:100%;padding:.82rem;font-family:'Bebas Neue',cursive;font-size:1.05rem;letter-spacing:.18em;border:1px solid var(--bd2);border-radius:1px;cursor:pointer;transition:all .18s;position:relative;overflow:hidden;}
.btn::before{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.05),transparent);transform:translateX(-100%);transition:.4s;}
.btn:hover::before{transform:translateX(100%);}
.btn-p{background:linear-gradient(180deg,#3c3c3c 0%,#1e1e1e 100%);color:var(--bright);border-color:var(--bb3);box-shadow:0 2px 0 #000,0 4px 12px rgba(0,0,0,.4),inset 0 1px 0 rgba(255,255,255,.07);margin-bottom:.7rem;}
.btn-p:hover{background:linear-gradient(180deg,#484848 0%,#282828 100%);border-color:var(--silver);}
.btn-p:active{transform:translateY(1px);box-shadow:0 1px 0 #000;}
.btn-s{background:transparent;color:var(--muted);border-color:var(--border);}
.btn-s:hover{border-color:var(--bd2);color:var(--text);}
.divider{display:flex;align-items:center;gap:.6rem;color:#222;font-size:.58rem;letter-spacing:.2em;margin:.65rem 0;}
.divider::before,.divider::after{content:'';flex:1;height:1px;background:var(--border);}
.err{color:#ff4455;font-size:.68rem;text-align:center;min-height:1em;margin-top:.4rem;}

/* â”€â”€â”€ STATUS â”€â”€â”€ */
#status-bar{position:fixed;top:0;left:0;right:0;z-index:999;pointer-events:none;display:flex;justify-content:center;padding:.4rem;}
.status-pill{background:rgba(20,20,20,.95);border:1px solid var(--border);border-radius:1px;padding:.3rem .8rem;font-size:.6rem;letter-spacing:.1em;color:var(--muted);display:none;}
.status-pill.show{display:block;}
.status-pill.conn{border-color:#444;color:var(--text);}
.status-pill.err{border-color:#552233;color:#ff6677;}

/* â”€â”€â”€ LOBBY â”€â”€â”€ */
#screen-lobby{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(155deg,#111 0%,#0a0a0a 100%);z-index:99;}
.lbox{background:var(--panel);border:1px solid var(--border);border-radius:1px;padding:1.6rem;width:min(720px,96vw);max-height:90vh;overflow-y:auto;position:relative;box-shadow:0 8px 40px rgba(0,0,0,.6);}
.lbox::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--silver),transparent);}
.ltitle{font-family:'Bebas Neue',cursive;font-size:1.2rem;color:var(--bright);text-align:center;letter-spacing:.25em;margin-bottom:.22rem;}
.rcode{font-family:'Bebas Neue',cursive;font-size:2.5rem;color:var(--gold);letter-spacing:.35em;text-align:center;padding:.45rem;border:1px dashed rgba(224,184,64,.3);border-radius:1px;margin:.4rem 0 1.2rem;text-shadow:0 0 20px rgba(224,184,64,.25);}
.plist{display:grid;grid-template-columns:repeat(auto-fill,minmax(135px,1fr));gap:.65rem;margin-bottom:1.2rem;}
.ptile{background:#111;border:1px solid var(--border);border-radius:1px;padding:.7rem;text-align:center;animation:popin .22s cubic-bezier(.34,1.56,.64,1);position:relative;}
.ptile::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--bb3),transparent);}
@keyframes popin{from{transform:scale(.65);opacity:0}to{transform:scale(1);opacity:1}}
.ptile.me{border-color:var(--silver);}
.ptile img,.ptile canvas{width:54px;height:54px;object-fit:cover;border:1px solid var(--border);display:block;margin:0 auto .3rem;border-radius:1px;background:#0a0a0a;}
.pname{font-size:.74rem;color:var(--text);}
.pbadge{display:inline-block;font-size:.5rem;padding:.07rem .28rem;border-radius:1px;letter-spacing:.08em;margin-left:.22rem;vertical-align:middle;}
.bh{background:var(--silver);color:#000;}
.bm{background:var(--gold);color:#000;}
.chint{font-size:.58rem;color:var(--muted);text-align:center;letter-spacing:.08em;margin-bottom:.7rem;}

/* â”€â”€â”€ GAME â”€â”€â”€ */
#screen-game{position:fixed;inset:0;display:none;}
canvas{position:absolute;}
#cv-bg{z-index:1;}#cv-main{z-index:2;}
#hud{position:absolute;inset:0;z-index:4;pointer-events:none;}
#hud-top{position:absolute;top:0;left:0;right:0;padding:9px 14px;display:flex;justify-content:space-between;align-items:center;background:linear-gradient(to bottom,rgba(0,0,0,.82),transparent);border-bottom:1px solid rgba(255,255,255,.025);}
.hud-r{font-family:'Bebas Neue',cursive;font-size:.82rem;color:var(--gold);letter-spacing:.18em;}
.hud-k{font-family:'Bebas Neue',cursive;font-size:.88rem;color:var(--bright);letter-spacing:.14em;}
#sb-hud{position:absolute;top:38px;right:11px;background:rgba(12,12,12,.92);border:1px solid var(--border);border-radius:1px;padding:.42rem .7rem;min-width:148px;}
.se{display:flex;justify-content:space-between;gap:.7rem;font-size:.62rem;padding:.1rem 0;border-bottom:1px solid rgba(255,255,255,.035);}
.se:last-child{border-bottom:none;}
.sn{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:var(--text);}
.sk{color:var(--silver);font-family:'Russo One',sans-serif;}
#kf{position:absolute;top:38px;left:11px;display:flex;flex-direction:column;gap:3px;pointer-events:none;}
.ke{font-size:.64rem;background:rgba(12,12,12,.88);border-left:2px solid var(--silver);padding:.13rem .42rem;border-radius:0 1px 1px 0;animation:fi .22s ease;}
@keyframes fi{from{opacity:0;transform:translateX(-14px)}to{opacity:1;transform:translateX(0)}}
#hp-wrap{position:absolute;bottom:16px;left:14px;width:150px;}
#hp-lbl{font-size:.52rem;color:var(--muted);letter-spacing:.14em;margin-bottom:3px;}
#hp-bg{height:7px;background:rgba(255,255,255,.06);border-radius:1px;overflow:hidden;border:1px solid var(--border);}
#hp-fill{height:100%;border-radius:1px;background:linear-gradient(90deg,#aa0011,#cc3344);transition:width .18s;}
#ctrl-hud{position:absolute;bottom:14px;left:50%;transform:translateX(-50%);font-size:.52rem;color:#2a2a2a;letter-spacing:.1em;white-space:nowrap;}
#dmg-flash{position:absolute;inset:0;z-index:5;pointer-events:none;opacity:0;background:radial-gradient(ellipse at center,transparent 30%,rgba(255,34,51,.4) 100%);transition:opacity .05s;}
#dead-ov{position:absolute;inset:0;background:rgba(0,0,0,.65);display:none;flex-direction:column;align-items:center;justify-content:center;z-index:10;backdrop-filter:blur(7px);pointer-events:none;}
.dead-t{font-family:'Bebas Neue',cursive;font-size:clamp(3rem,10vw,6rem);color:var(--bright);letter-spacing:.22em;}
.dead-s{font-family:'Share Tech Mono',monospace;font-size:.9rem;color:var(--muted);margin-top:.6rem;letter-spacing:.14em;}
#mob-shoot{position:absolute;bottom:78px;right:28px;display:none;z-index:20;width:64px;height:64px;border-radius:50%;background:rgba(30,30,30,.85);border:1px solid var(--bd2);color:var(--text);cursor:pointer;pointer-events:auto;align-items:center;justify-content:center;font-size:.8rem;}
@media(max-width:640px){#mob-shoot{display:flex;}}

/* â”€â”€â”€ WINNER â”€â”€â”€ */
#screen-winner{position:fixed;inset:0;display:none;flex-direction:column;align-items:center;justify-content:center;background:rgba(6,6,6,.97);z-index:200;backdrop-filter:blur(12px);}
#screen-winner::before{content:'';position:absolute;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 39px,rgba(255,255,255,.01) 40px),repeating-linear-gradient(90deg,transparent,transparent 39px,rgba(255,255,255,.01) 40px);pointer-events:none;}
.w-trophy{font-size:4.5rem;margin-bottom:.4rem;filter:grayscale(.2);}
.w-label{font-family:'Bebas Neue',cursive;font-size:clamp(2rem,7vw,4rem);color:var(--gold);letter-spacing:.2em;text-shadow:0 0 25px rgba(224,184,64,.3);margin-bottom:.2rem;}
.w-name{font-family:'Russo One',sans-serif;font-size:clamp(1.2rem,3.5vw,2rem);color:var(--bright);margin-bottom:.5rem;}
#w-img{width:110px;height:110px;object-fit:cover;border:1px solid var(--bd2);margin-bottom:1.8rem;background:#0a0a0a;}
.hidden{display:none!important;}
</style>
</head>
<body>

<div id="status-bar"><div class="status-pill" id="ws-status">CONNECTING...</div></div>

<!-- â•â• TITLE â•â• -->
<div id="screen-title">
  <div class="stripe"></div>
  <div class="game-logo"><span>TEMBAK!</span></div>
  <div class="logo-sub">// multiplayer arena shooter //</div>

  <div class="panel">
    <div class="corner corner-tl"></div><div class="corner corner-tr"></div>
    <div class="corner corner-bl"></div><div class="corner corner-br"></div>

    <div class="lbl">Nama Kamu</div>
    <input class="inp" id="inp-name" placeholder="masukkan nama..." maxlength="14">

    <div class="lbl">Avatar</div>
    <div class="avatar-tabs">
      <div class="av-tab active" onclick="switchTab('draw')">âœ GAMBAR</div>
      <div class="av-tab" onclick="switchTab('upload')">ğŸ“· UPLOAD FOTO</div>
    </div>

    <!-- DRAW -->
    <div class="av-pane active" id="pane-draw">
      <div class="draw-wrap">
        <div class="canvas-col">
          <canvas id="draw-canvas" width="100" height="100"></canvas>
          <div class="ch">GAMBAR DI SINI</div>
        </div>
        <div class="tools-col">
          <div>
            <div class="tl">WARNA</div>
            <div class="swatch-row" id="color-row"></div>
          </div>
          <div>
            <div class="tl">UKURAN</div>
            <div class="sz-row" id="size-row"></div>
          </div>
          <div>
            <div class="tl">MODE</div>
            <div class="tb-row">
              <div class="tb on" id="tb-pen" onclick="setTool('pen')">âœ PEN</div>
              <div class="tb" id="tb-era" onclick="setTool('eraser')">â¬œ ERASER</div>
            </div>
          </div>
          <div class="act-row">
            <div class="ab" onclick="undoDraw()">â†© UNDO</div>
            <div class="ab" onclick="clearDraw()">âœ• CLEAR</div>
          </div>
        </div>
      </div>
    </div>

    <!-- UPLOAD -->
    <div class="av-pane" id="pane-upload">
      <div class="upload-wrap">
        <div class="upload-drop" id="upload-drop" onclick="document.getElementById('file-input').click()" ondragover="onDragOver(event)" ondragleave="onDragLeave(event)" ondrop="onDrop(event)">
          <div class="upload-icon">ğŸ“·</div>
          <div class="upload-txt">KLIK ATAU DRAG FOTO</div>
          <div class="upload-hint">JPG, PNG, GIF â€” maks 2MB</div>
        </div>
        <input type="file" id="file-input" accept="image/*" onchange="onFileSelect(event)">
        <div class="preview-row">
          <img id="upload-preview" src="" alt="preview">
          <div class="upload-info">
            <div id="upload-filename" style="font-size:.7rem;color:var(--text)"></div>
            <div id="upload-clear" onclick="clearUpload()">Ã— hapus foto</div>
          </div>
        </div>
      </div>
    </div>

    <div style="height:.8rem"></div>
    <button class="btn btn-p" onclick="createRoom()">âš” BUAT ROOM</button>
    <div class="divider">atau</div>
    <input class="inp" id="inp-code" placeholder="kode room (4 huruf)..." maxlength="4" style="text-transform:uppercase;margin-bottom:.7rem">
    <button class="btn btn-s" onclick="joinRoom()">â†’ GABUNG ROOM</button>
    <div class="err" id="title-err"></div>
  </div>
</div>

<!-- â•â• LOBBY â•â• -->
<div id="screen-lobby" class="hidden">
  <div class="lbox">
    <div class="ltitle">LOBBY ARENA</div>
    <div class="rcode" id="lobby-code">----</div>
    <div class="chint">WASD = GERAK | MOUSE = BIDIK | KLIK = TEMBAK | R = RELOAD</div>
    <div style="font-size:.58rem;color:#252525;text-align:center;margin-bottom:.9rem;letter-spacing:.08em">BUKA TAB BARU â†’ MASUKKAN KODE DI ATAS UNTUK BERMAIN</div>
    <div class="plist" id="lobby-players"></div>
    <div id="host-btns">
      <button class="btn btn-p" onclick="startGame()">â–¶ MULAI PERTEMPURAN</button>
    </div>
    <div id="guest-wait" class="hidden" style="text-align:center;color:var(--muted);font-size:.7rem;letter-spacing:.14em;margin-top:.5rem">MENUNGGU HOST...</div>
    <button class="btn btn-s" style="margin-top:.7rem" onclick="leaveRoom()">â† KELUAR</button>
  </div>
</div>

<!-- â•â• GAME â•â• -->
<div id="screen-game">
  <canvas id="cv-bg"></canvas>
  <canvas id="cv-main"></canvas>
  <div id="hud">
    <div id="hud-top">
      <div class="hud-r">ROOM: <span id="hud-code" style="color:var(--gold)">----</span></div>
      <div class="hud-k">KILLS: <span id="my-kills">0</span></div>
    </div>
    <div id="kf"></div>
    <div id="sb-hud"></div>
    <div id="hp-wrap"><div id="hp-lbl">HP</div><div id="hp-bg"><div id="hp-fill" style="width:100%"></div></div></div>
    <div id="ctrl-hud">WASD MOVE | MOUSE AIM | CLICK SHOOT | R RELOAD</div>
    <div id="dmg-flash"></div>
  </div>
  <div id="dead-ov">
    <div class="dead-t">YOU DIED</div>
    <div class="dead-s" id="dead-s">RESPAWN DALAM 3...</div>
  </div>
  <button id="mob-shoot" ontouchstart="mouseDown=true" ontouchend="mouseDown=false">ğŸ”«</button>
</div>

<!-- â•â• WINNER â•â• -->
<div id="screen-winner">
  <div class="w-trophy">ğŸ†</div>
  <div class="w-label">PEMENANG</div>
  <div class="w-name" id="w-name"></div>
  <img id="w-img" src="" alt="winner">
  <button class="btn btn-p" style="width:210px" onclick="send({type:'back_to_lobby'})">MAIN LAGI</button>
  <button class="btn btn-s" style="width:210px;margin-top:.55rem" onclick="goHome()">MENU UTAMA</button>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DRAWING TOOL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DRAW_COLORS=['#ffffff','#aaaaaa','#555555','#111111','#ff2233','#ff8800','#ffdd00','#00cc44','#0088ff','#aa44ff','#ff44aa','#00eeff'];
const DRAW_SIZES=[{v:2,l:'S'},{v:4,l:'M'},{v:8,l:'L'},{v:14,l:'XL'}];
let curColor='#ffffff',curSize=4,curTool='pen',painting=false,history=[],lastX=0,lastY=0;
let uploadedDataURL='';
let activeTab='draw';

const dc=document.getElementById('draw-canvas'),dctx=dc.getContext('2d');
dctx.fillStyle='#0a0a0a';dctx.fillRect(0,0,100,100);

// Colors
const cr=document.getElementById('color-row');
DRAW_COLORS.forEach((c,i)=>{
  const el=document.createElement('div');el.className='sw'+(i===0?' on':'');
  el.style.background=c;if(c==='#ffffff')el.style.boxShadow='0 0 0 1px #333';
  el.onclick=()=>{curColor=c;curTool='pen';document.querySelectorAll('.sw').forEach(s=>s.classList.remove('on'));el.classList.add('on');document.getElementById('tb-pen').classList.add('on');document.getElementById('tb-era').classList.remove('on');};
  cr.appendChild(el);
});

// Sizes
const srw=document.getElementById('size-row');
DRAW_SIZES.forEach((s,i)=>{
  const el=document.createElement('div');el.className='szb'+(i===1?' on':'');el.textContent=s.l;
  el.onclick=()=>{curSize=s.v;document.querySelectorAll('.szb').forEach(b=>b.classList.remove('on'));el.classList.add('on');};
  srw.appendChild(el);
});

function setTool(t){curTool=t;document.getElementById('tb-pen').classList.toggle('on',t==='pen');document.getElementById('tb-era').classList.toggle('on',t==='eraser');}
function saveH(){history.push(dctx.getImageData(0,0,100,100));if(history.length>30)history.shift();}
function undoDraw(){if(history.length)dctx.putImageData(history.pop(),0,0);}
function clearDraw(){saveH();dctx.fillStyle='#0a0a0a';dctx.fillRect(0,0,100,100);}
function getP(e){const r=dc.getBoundingClientRect(),sx=100/r.width,sy=100/r.height;const src=e.touches?e.touches[0]:e;return{x:(src.clientX-r.left)*sx,y:(src.clientY-r.top)*sy};}
dc.addEventListener('mousedown',e=>{saveH();painting=true;const p=getP(e);lastX=p.x;lastY=p.y;dctx.beginPath();dctx.arc(p.x,p.y,curSize/2,0,Math.PI*2);dctx.fillStyle=curTool==='eraser'?'#0a0a0a':curColor;dctx.fill();});
dc.addEventListener('mousemove',e=>{if(!painting)return;const p=getP(e);dctx.beginPath();dctx.moveTo(lastX,lastY);dctx.lineTo(p.x,p.y);dctx.strokeStyle=curTool==='eraser'?'#0a0a0a':curColor;dctx.lineWidth=curSize;dctx.lineCap='round';dctx.lineJoin='round';dctx.stroke();lastX=p.x;lastY=p.y;});
dc.addEventListener('mouseup',()=>painting=false);dc.addEventListener('mouseleave',()=>painting=false);
dc.addEventListener('touchstart',e=>{e.preventDefault();saveH();painting=true;const p=getP(e);lastX=p.x;lastY=p.y;},{passive:false});
dc.addEventListener('touchmove',e=>{e.preventDefault();if(!painting)return;const p=getP(e);dctx.beginPath();dctx.moveTo(lastX,lastY);dctx.lineTo(p.x,p.y);dctx.strokeStyle=curTool==='eraser'?'#0a0a0a':curColor;dctx.lineWidth=curSize;dctx.lineCap='round';dctx.lineJoin='round';dctx.stroke();lastX=p.x;lastY=p.y;},{passive:false});
dc.addEventListener('touchend',()=>painting=false);

// Tabs
function switchTab(t){
  activeTab=t;
  document.querySelectorAll('.av-tab').forEach((el,i)=>el.classList.toggle('active',['draw','upload'][i]===t));
  document.querySelectorAll('.av-pane').forEach((el,i)=>el.classList.toggle('active',['draw','upload'][i]===t));
}

// Upload
function onDragOver(e){e.preventDefault();document.getElementById('upload-drop').classList.add('drag');}
function onDragLeave(e){document.getElementById('upload-drop').classList.remove('drag');}
function onDrop(e){e.preventDefault();onDragLeave(e);if(e.dataTransfer.files[0])processFile(e.dataTransfer.files[0]);}
function onFileSelect(e){if(e.target.files[0])processFile(e.target.files[0]);}

function processFile(file){
  if(!file.type.startsWith('image/')){setErr('File harus berupa gambar!');return;}
  if(file.size>2*1024*1024){setErr('Foto maks 2MB!');return;}
  const reader=new FileReader();
  reader.onload=ev=>{
    uploadedDataURL=ev.target.result;
    const prev=document.getElementById('upload-preview');
    prev.src=uploadedDataURL;prev.style.display='block';
    document.getElementById('upload-filename').textContent=file.name;
    document.getElementById('upload-clear').style.display='block';
  };
  reader.readAsDataURL(file);
}

function clearUpload(){
  uploadedDataURL='';
  document.getElementById('upload-preview').style.display='none';
  document.getElementById('upload-filename').textContent='';
  document.getElementById('upload-clear').style.display='none';
  document.getElementById('file-input').value='';
}

function getAvatarURL(){
  if(activeTab==='upload'&&uploadedDataURL) return uploadedDataURL;
  // Resize draw canvas to 100x100 data URL
  return dc.toDataURL('image/png');
}

// Compress image to max ~60KB for WebSocket transport
function compressImage(dataURL,cb){
  const img=new Image();img.onload=()=>{
    const c=document.createElement('canvas');c.width=80;c.height=80;
    const cx=c.getContext('2d');cx.drawImage(img,0,0,80,80);
    cb(c.toDataURL('image/jpeg',0.5));
  };img.src=dataURL;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WEBSOCKET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let ws=null,myId='',myName='',roomCode='',isHost=false;
let myAvatarURL='';

function wsConnect(){
  const proto=location.protocol==='https:'?'wss:':'ws:';
  const url=proto+'//'+location.host;
  ws=new WebSocket(url);

  ws.onopen=()=>{setStatus('TERHUBUNG','conn');};
  ws.onclose=()=>{setStatus('TERPUTUS â€” coba refresh','err');setTimeout(wsConnect,3000);};
  ws.onerror=()=>{setStatus('CONNECTION ERROR','err');};
  ws.onmessage=e=>handleMsg(JSON.parse(e.data));
}

function send(msg){if(ws&&ws.readyState===WebSocket.OPEN)ws.send(JSON.stringify(msg));}

function setStatus(txt,cls){
  const el=document.getElementById('ws-status');
  el.textContent=txt;el.className='status-pill show '+(cls||'');
  if(cls==='conn')setTimeout(()=>el.classList.remove('show'),2500);
}

function setErr(m){document.getElementById('title-err').textContent=m;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SERVER MESSAGE HANDLER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function handleMsg(msg){
  switch(msg.type){
    case 'room_created':
      myId=msg.playerId;roomCode=msg.code;isHost=true;
      enterLobby(msg.room);break;

    case 'room_joined':
      myId=msg.playerId;roomCode=msg.code;isHost=false;
      enterLobby(msg.room);break;

    case 'error':
      setErr(msg.msg);break;

    case 'player_joined':
      if(rooms[roomCode])rooms[roomCode].players[msg.player.id]=msg.player;
      updateLobbyUI();break;

    case 'player_left':
      if(rooms[roomCode]){
        delete rooms[roomCode].players[msg.id];
        if(msg.newHost===myId){isHost=true;document.getElementById('host-btns').classList.remove('hidden');document.getElementById('guest-wait').classList.add('hidden');}
      }
      updateLobbyUI();break;

    case 'game_started':
      rooms[roomCode]=msg.room;beginGame(msg.room);break;

    case 'player_update':
      if(remotePlayers[msg.id]){Object.assign(remotePlayers[msg.id],{x:msg.x,y:msg.y,angle:msg.angle,hp:msg.hp,alive:msg.alive});}break;

    case 'bullet_fired':
      addRemoteBullet(msg.shooterId,msg.x,msg.y,msg.angle);break;

    case 'player_damaged':
      if(msg.targetId===myId&&!isDead){
        me.hp=msg.hp;flashDmg();
        if(me.hp<=0){me.hp=0;die();}
      } else if(remotePlayers[msg.targetId]){remotePlayers[msg.targetId].hp=msg.hp;}
      break;

    case 'player_killed':
      addKillFeed(msg.killerName,msg.targetName);
      if(remotePlayers[msg.killerId])remotePlayers[msg.killerId].kills=msg.killerKills;
      if(msg.targetId===myId&&!isDead){me.hp=0;die();}
      else if(remotePlayers[msg.targetId])remotePlayers[msg.targetId].alive=false;
      break;

    case 'player_respawned':
      if(remotePlayers[msg.id])Object.assign(remotePlayers[msg.id],{x:msg.x,y:msg.y,hp:100,alive:true});break;

    case 'back_to_lobby':
      rooms[roomCode]=msg.room;
      goBackLobby(msg.room);break;

    case 'game_over':
      showWinner(msg);break;
  }
}

// Local room cache for lobby display
const rooms={};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ROOM UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function createRoom(){
  const name=document.getElementById('inp-name').value.trim();
  if(!name){setErr('Masukkan nama dulu!');return;}
  myName=name;
  compressImage(getAvatarURL(),url=>{
    myAvatarURL=url;
    send({type:'create_room',name,avatar:url});
  });
}

async function joinRoom(){
  const name=document.getElementById('inp-name').value.trim();
  const code=document.getElementById('inp-code').value.trim().toUpperCase();
  if(!name){setErr('Masukkan nama!');return;}
  if(code.length!==4){setErr('Kode harus 4 huruf!');return;}
  myName=name;
  compressImage(getAvatarURL(),url=>{
    myAvatarURL=url;
    send({type:'join_room',name,code,avatar:url});
  });
}

function enterLobby(room){
  rooms[roomCode]=room;
  document.getElementById('screen-title').style.display='none';
  document.getElementById('screen-lobby').classList.remove('hidden');
  document.getElementById('lobby-code').textContent=room.code;
  document.getElementById('hud-code').textContent=room.code;
  document.getElementById(isHost?'guest-wait':'host-btns').classList.add('hidden');
  document.getElementById(isHost?'host-btns':'guest-wait').classList.remove('hidden');
  updateLobbyUI();
}

function updateLobbyUI(){
  const room=rooms[roomCode];if(!room)return;
  const list=document.getElementById('lobby-players');list.innerHTML='';
  Object.values(room.players).forEach(p=>{
    const div=document.createElement('div');div.className='ptile'+(p.id===myId?' me':'');
    const img=document.createElement('img');img.src=p.avatar;img.style.cssText='width:54px;height:54px;object-fit:cover;border:1px solid var(--border);display:block;margin:0 auto .3rem;border-radius:1px;background:#0a0a0a;';
    div.appendChild(img);
    const nd=document.createElement('div');nd.className='pname';
    nd.innerHTML=p.name+(p.id===room.host?'<span class="pbadge bh">HOST</span>':'')+(p.id===myId?'<span class="pbadge bm">KAMU</span>':'');
    div.appendChild(nd);
    list.appendChild(div);
  });
}

function startGame(){send({type:'start_game'});}

function leaveRoom(){
  send({type:'leave_room'});
  document.getElementById('screen-lobby').classList.add('hidden');
  document.getElementById('screen-title').style.display='flex';
  stopGame();
}

function goHome(){
  stopGame();
  document.getElementById('screen-winner').style.display='none';
  document.getElementById('screen-lobby').classList.add('hidden');
  document.getElementById('screen-title').style.display='flex';
}

function goBackLobby(room){
  stopGame();
  document.getElementById('screen-winner').style.display='none';
  document.getElementById('screen-game').style.display='none';
  rooms[roomCode]=room;
  document.getElementById('screen-lobby').classList.remove('hidden');
  document.getElementById(isHost?'guest-wait':'host-btns').classList.add('hidden');
  document.getElementById(isHost?'host-btns':'guest-wait').classList.remove('hidden');
  updateLobbyUI();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MAP_W=1600,MAP_H=1200,PR=20,BSPD=10,BLIFE=65,MAX_HP=100,MAX_AMMO=8,RLD_T=120,MSPD=3.6,KILLS_WIN=10,RESP_D=180;
const WALLS=[{x:200,y:150,w:180,h:28},{x:600,y:80,w:28,h:200},{x:900,y:200,w:250,h:28},{x:1300,y:100,w:28,h:250},{x:100,y:400,w:200,h:28},{x:450,y:350,w:28,h:180},{x:700,y:400,w:200,h:28},{x:1000,y:350,w:28,h:200},{x:1250,y:420,w:200,h:28},{x:200,y:650,w:28,h:200},{x:500,y:600,w:200,h:28},{x:800,y:650,w:28,h:200},{x:1100,y:600,w:200,h:28},{x:1400,y:650,w:28,h:200},{x:150,y:900,w:250,h:28},{x:600,y:870,w:28,h:200},{x:900,y:950,w:200,h:28},{x:1200,y:870,w:28,h:200},{x:680,y:520,w:80,h:80},{x:840,y:520,w:80,h:80},{x:760,y:440,w:80,h:28},{x:760,y:640,w:80,h:28}];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let me=null,remotePlayers={},myBullets=[],remoteBullets={};
let camX=0,camY=0,keys={},mouseX=0,mouseY=0,mouseDown=false;
let shootCD=0,reloading=false,rldT=0,myKills=0;
let isDead=false,deadT=0,gameRunning=false,animId=null,frameN=0;
let lastSync=0;
const SYNC_MS=80;

const bgCv=document.getElementById('cv-bg'),bgCtx=bgCv.getContext('2d');
const mainCv=document.getElementById('cv-main'),ctx=mainCv.getContext('2d');
let W,H;

const imgCache={};
function getImg(url){if(!imgCache[url]){const i=new Image();i.src=url;imgCache[url]=i;}return imgCache[url];}

function wallCollide(x,y,r){if(x-r<0||x+r>MAP_W||y-r<0||y+r>MAP_H)return true;return WALLS.some(w=>x+r>w.x&&x-r<w.x+w.w&&y+r>w.y&&y-r<w.y+w.h);}
function bHitWall(bx,by){if(bx<0||bx>MAP_W||by<0||by>MAP_H)return true;return WALLS.some(w=>bx>w.x&&bx<w.x+w.w&&by>w.y&&by<w.y+w.h);}

function beginGame(room){
  document.getElementById('screen-lobby').classList.add('hidden');
  document.getElementById('screen-game').style.display='block';
  W=window.innerWidth;H=window.innerHeight;
  [bgCv,mainCv].forEach(c=>{c.width=W;c.height=H;});
  bgCtx.fillStyle='#0e0e0e';bgCtx.fillRect(0,0,W,H);

  const pd=room.players[myId];
  me={x:pd.x,y:pd.y,angle:0,hp:MAX_HP,ammo:MAX_AMMO,kills:0,alive:true};
  remotePlayers={};myBullets=[];remoteBullets={};myKills=0;isDead=false;deadT=0;frameN=0;gameRunning=true;

  Object.entries(room.players).forEach(([id,p])=>{
    if(id!==myId){remotePlayers[id]=p;getImg(p.avatar);}
  });
  getImg(myAvatarURL);

  document.addEventListener('keydown',e=>{keys[e.code]=true;if(['Space','ArrowUp','ArrowDown'].includes(e.code))e.preventDefault();});
  document.addEventListener('keyup',e=>{keys[e.code]=false;});
  mainCv.addEventListener('mousemove',e=>{const r=mainCv.getBoundingClientRect();mouseX=e.clientX-r.left;mouseY=e.clientY-r.top;});
  mainCv.addEventListener('mousedown',()=>mouseDown=true);
  mainCv.addEventListener('mouseup',()=>mouseDown=false);

  animId=requestAnimationFrame(gameLoop);
}

function stopGame(){
  gameRunning=false;if(animId)cancelAnimationFrame(animId);animId=null;
  document.removeEventListener('keydown',()=>{});
  document.removeEventListener('keyup',()=>{});
}

window.addEventListener('resize',()=>{if(!gameRunning)return;W=window.innerWidth;H=window.innerHeight;[bgCv,mainCv].forEach(c=>{c.width=W;c.height=H;});bgCtx.fillStyle='#0e0e0e';bgCtx.fillRect(0,0,W,H);});

function gameLoop(ts){
  if(!gameRunning)return;
  frameN++;update(ts);render();
  animId=requestAnimationFrame(gameLoop);
}

function update(ts){
  if(isDead){
    deadT--;
    if(deadT<=0)respawn();
    else document.getElementById('dead-s').textContent='RESPAWN DALAM '+Math.ceil(deadT/60)+'...';
    return;
  }

  let dx=0,dy=0;
  if(keys['KeyW']||keys['ArrowUp'])dy-=MSPD;if(keys['KeyS']||keys['ArrowDown'])dy+=MSPD;
  if(keys['KeyA']||keys['ArrowLeft'])dx-=MSPD;if(keys['KeyD']||keys['ArrowRight'])dx+=MSPD;
  if(dx&&dy){dx*=.707;dy*=.707;}
  if(!wallCollide(me.x+dx,me.y,PR))me.x+=dx;
  if(!wallCollide(me.x,me.y+dy,PR))me.y+=dy;
  me.angle=Math.atan2(mouseY-(me.y-camY),mouseX-(me.x-camX));

  camX+=(me.x-W/2-camX)*.1;camY+=(me.y-H/2-camY)*.1;
  camX=Math.max(0,Math.min(MAP_W-W,camX));camY=Math.max(0,Math.min(MAP_H-H,camY));

  if(keys['KeyR']&&me.ammo<MAX_AMMO&&!reloading){reloading=true;rldT=RLD_T;}
  if(reloading){rldT--;if(rldT<=0){me.ammo=MAX_AMMO;reloading=false;}}
  if(me.ammo===0&&!reloading){reloading=true;rldT=RLD_T;}
  if(shootCD>0)shootCD--;
  if(mouseDown&&shootCD===0&&me.ammo>0&&!reloading)shoot();

  // Update my bullets, check wall hits & remote player hits
  myBullets=myBullets.filter(b=>{
    b.x+=Math.cos(b.angle)*BSPD;b.y+=Math.sin(b.angle)*BSPD;b.life--;
    if(bHitWall(b.x,b.y)||b.life<=0)return false;
    let hit=false;
    Object.entries(remotePlayers).forEach(([id,p])=>{
      if(!p.alive)return;
      if(Math.hypot(b.x-p.x,b.y-p.y)<PR+5){
        hit=true;
        send({type:'register_hit',targetId:id,damage:25});
      }
    });
    return !hit;
  });

  // Move remote bullets
  Object.values(remoteBullets).forEach(arr=>{arr.forEach(b=>{if(b.active){b.x+=Math.cos(b.angle)*BSPD*.6;b.y+=Math.sin(b.angle)*BSPD*.6;b.life--;if(b.life<=0)b.active=false;}});});

  // Sync position to server periodically
  if(ts-lastSync>SYNC_MS){
    lastSync=ts;
    send({type:'player_update',x:me.x,y:me.y,angle:me.angle,hp:me.hp,ammo:me.ammo,alive:true});
  }

  updateHUD();
}

function shoot(){
  if(isDead)return;
  const bx=me.x+Math.cos(me.angle)*PR,by=me.y+Math.sin(me.angle)*PR;
  myBullets.push({x:bx,y:by,angle:me.angle,life:BLIFE,active:true});
  me.ammo--;shootCD=12;
  send({type:'bullet_fired',x:bx,y:by,angle:me.angle});
}

function addRemoteBullet(shooterId,x,y,angle){
  if(!remoteBullets[shooterId])remoteBullets[shooterId]=[];
  remoteBullets[shooterId].push({x,y,angle,life:BLIFE,active:true});
}

function flashDmg(){const el=document.getElementById('dmg-flash');el.style.opacity='1';setTimeout(()=>el.style.opacity='0',85);}

function die(){
  if(isDead)return;isDead=true;deadT=RESP_D;
  document.getElementById('dead-ov').style.display='flex';
  send({type:'player_update',x:me.x,y:me.y,angle:me.angle,hp:0,ammo:me.ammo,alive:false});
}

function respawn(){
  isDead=false;deadT=0;me.hp=MAX_HP;me.ammo=MAX_AMMO;reloading=false;
  document.getElementById('dead-ov').style.display='none';
  send({type:'respawn'});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render(){
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle='#0e0e0e';ctx.fillRect(0,0,W,H);

  // Grid
  ctx.strokeStyle='rgba(255,255,255,.024)';ctx.lineWidth=1;
  const gs=60,ox=(-camX)%gs,oy=(-camY)%gs;
  for(let x=ox;x<W;x+=gs){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke();}
  for(let y=oy;y<H;y+=gs){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();}

  // Map border
  ctx.strokeStyle='rgba(255,255,255,.18)';ctx.lineWidth=2;ctx.strokeRect(-camX,-camY,MAP_W,MAP_H);

  // Walls
  WALLS.forEach(w=>{
    const wx=w.x-camX,wy=w.y-camY;
    ctx.fillStyle='rgba(0,0,0,.45)';ctx.fillRect(wx+3,wy+3,w.w,w.h);
    const g=ctx.createLinearGradient(wx,wy,wx,wy+w.h);g.addColorStop(0,'#2c2c2c');g.addColorStop(.5,'#1a1a1a');g.addColorStop(1,'#0f0f0f');
    ctx.fillStyle=g;ctx.fillRect(wx,wy,w.w,w.h);
    ctx.fillStyle='rgba(255,255,255,.055)';ctx.fillRect(wx,wy,w.w,2);
    ctx.strokeStyle='rgba(255,255,255,.07)';ctx.lineWidth=1;ctx.strokeRect(wx,wy,w.w,w.h);
    // Corner screws
    ctx.fillStyle='rgba(255,255,255,.1)';
    [[wx+2,wy+2],[wx+w.w-2,wy+2],[wx+2,wy+w.h-2],[wx+w.w-2,wy+w.h-2]].forEach(([cx,cy])=>{ctx.beginPath();ctx.arc(cx,cy,1.5,0,Math.PI*2);ctx.fill();});
  });

  // Remote players
  Object.values(remotePlayers).forEach(p=>{if(p.alive)drawPlayer(p,false);});
  // Me
  if(!isDead)drawPlayer({x:me.x,y:me.y,angle:me.angle,hp:me.hp,alive:true,avatar:myAvatarURL,name:'YOU'},true);

  // My bullets
  myBullets.forEach(b=>{
    const bx=b.x-camX,by=b.y-camY;
    ctx.save();ctx.beginPath();ctx.arc(bx,by,4,0,Math.PI*2);
    ctx.fillStyle='#eee';ctx.shadowColor='#fff';ctx.shadowBlur=8;ctx.fill();
    ctx.beginPath();ctx.moveTo(bx,by);ctx.lineTo(bx-Math.cos(b.angle)*14,by-Math.sin(b.angle)*14);
    ctx.strokeStyle='rgba(220,220,220,.3)';ctx.lineWidth=2;ctx.stroke();ctx.restore();
  });

  // Remote bullets
  Object.values(remoteBullets).forEach(arr=>{
    arr.forEach(b=>{
      if(!b.active)return;
      const bx=b.x-camX,by=b.y-camY;
      ctx.save();ctx.beginPath();ctx.arc(bx,by,4,0,Math.PI*2);
      ctx.fillStyle='#bbb';ctx.shadowColor='#fff';ctx.shadowBlur=6;ctx.fill();
      ctx.beginPath();ctx.moveTo(bx,by);ctx.lineTo(bx-Math.cos(b.angle)*12,by-Math.sin(b.angle)*12);
      ctx.strokeStyle='rgba(180,180,180,.25)';ctx.lineWidth=2;ctx.stroke();ctx.restore();
    });
  });
}

function drawPlayer(p,isMe){
  const sx=p.x-camX,sy=p.y-camY;
  if(sx<-100||sx>W+100||sy<-100||sy>H+100)return;
  const sz=PR*2+6;
  ctx.save();ctx.translate(sx,sy);

  // Shadow
  ctx.beginPath();ctx.ellipse(3,8,PR,PR*.34,0,0,Math.PI*2);ctx.fillStyle='rgba(0,0,0,.38)';ctx.fill();

  // Glow for self
  if(isMe){ctx.beginPath();ctx.arc(0,0,PR+7,0,Math.PI*2);ctx.strokeStyle='rgba(255,255,255,.18)';ctx.lineWidth=1.5;ctx.stroke();}

  // Gun (rotated)
  ctx.rotate(p.angle);
  ctx.fillStyle='#252525';ctx.fillRect(PR-2,-3,18,7);
  ctx.fillStyle='rgba(255,255,255,.06)';ctx.fillRect(PR-2,-3,18,2);
  ctx.fillStyle='#333';ctx.fillRect(PR+12,-2,5,5);
  ctx.rotate(-p.angle);

  // Avatar image clipped to circle
  const img=getImg(p.avatar);
  ctx.save();
  ctx.beginPath();ctx.arc(0,0,PR,0,Math.PI*2);ctx.clip();
  if(img.complete&&img.naturalWidth>0)ctx.drawImage(img,-PR,-PR,sz,sz);
  else{ctx.fillStyle='#1a1a1a';ctx.fill();}
  ctx.restore();

  // Border ring
  ctx.beginPath();ctx.arc(0,0,PR,0,Math.PI*2);
  ctx.strokeStyle=isMe?'rgba(255,255,255,.45)':'rgba(150,150,150,.22)';ctx.lineWidth=1.5;ctx.stroke();

  ctx.restore();

  // Name
  ctx.save();
  ctx.font='bold 10px Share Tech Mono,monospace';ctx.textAlign='center';ctx.textBaseline='bottom';
  ctx.fillStyle=isMe?'#fff':'#888';
  ctx.fillText(isMe?'YOU':p.name,sx,sy-PR-11);ctx.restore();

  // HP bar
  const bw=44,bh=4,bx=sx-bw/2,by=sy+PR+7;
  ctx.fillStyle='rgba(0,0,0,.55)';ctx.fillRect(bx-1,by-1,bw+2,bh+2);
  ctx.fillStyle='#111';ctx.fillRect(bx,by,bw,bh);
  const pct=Math.max(0,p.hp/MAX_HP);
  ctx.fillStyle=pct>.5?'#777':pct>.25?'#555':'#ff2233';ctx.fillRect(bx,by,bw*pct,bh);
}

function updateHUD(){
  document.getElementById('hp-fill').style.width=(me.hp/MAX_HP*100)+'%';
  document.getElementById('my-kills').textContent=myKills;
  document.getElementById('ctrl-hud').textContent=reloading?'[ RELOADING... ]':('â–®'.repeat(me.ammo)+'â–¯'.repeat(MAX_AMMO-me.ammo)+'   WASD | AIM | CLICK SHOOT | R RELOAD');
  const all=[{name:'YOU',kills:myKills},...Object.values(remotePlayers).map(p=>({name:p.name,kills:p.kills||0}))];
  all.sort((a,b)=>b.kills-a.kills);
  document.getElementById('sb-hud').innerHTML='<div style="font-size:.52rem;color:#333;letter-spacing:.16em;margin-bottom:3px">SKOR</div>'+
    all.map((p,i)=>`<div class="se"><span style="color:#2a2a2a;min-width:14px">${i+1}</span><span class="sn">${p.name}</span><span class="sk">${p.kills}â˜…</span></div>`).join('');
}

function addKillFeed(killer,victim){
  const feed=document.getElementById('kf');
  const el=document.createElement('div');el.className='ke';
  el.innerHTML=`<span style="color:#888">${killer}</span> âœ• <span style="color:#444">${victim}</span>`;
  feed.insertBefore(el,feed.firstChild);setTimeout(()=>el.remove(),4000);
}

function showWinner(msg){
  stopGame();
  document.getElementById('w-name').textContent=msg.winnerName;
  const wimg=document.getElementById('w-img');
  if(msg.winnerAvatar)wimg.src=msg.winnerAvatar;
  document.getElementById('screen-game').style.display='none';
  document.getElementById('screen-winner').style.display='flex';
}

// Init
wsConnect();
</script>
</body>
</html>
